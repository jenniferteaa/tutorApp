var background=(function(){"use strict";function j(e){return e==null||typeof e=="function"?{main:e}:e}const u=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,v=j(()=>{console.log("VibeTutor: background script loaded"),u.runtime.onInstalled.addListener(async e=>{if(e.reason==="install"){console.log("VibeTutor: extension installed"),await O();try{await u.tabs.create({url:"https://example.com/welcome"})}catch(t){console.warn("VibeTutor: unable to open welcome tab",t)}}}),u.runtime.onMessage.addListener((e,t,r)=>{if(e?.type!=="GET_MONACO_CODE")return C(e).then(r).catch(s=>r({success:!1,error:String(s)})),!0}),chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="GET_MONACO_CODE"){if(!t.tab?.id){r({ok:!1,error:"missing tab id"});return}return chrome.scripting.executeScript({target:{tabId:t.tab.id},world:"MAIN",func:()=>{const s=window.monaco;if(!s?.editor)return{ok:!1,error:"monaco not found"};const n=(s.editor.getEditors?.()||[])[0];if(n?.getValue)return{ok:!0,code:n.getValue()};const o=s.editor.getModels?.()||[];return o.length?{ok:!0,code:o[0].getValue()}:{ok:!1,error:"no editor/model found"}}},s=>{r(s?.[0]?.result??{ok:!1,error:"no result"})}),!0}}),u.tabs.onUpdated.addListener((e,t,r)=>{t.status!=="complete"||!r.url||r.url.startsWith("chrome://")||r.url.startsWith("chrome-extension://")||console.debug("VibeTutor: tab updated",r.url)})});async function O(){try{await u.storage.local.set({"vibetutor-settings":{stealthMode:!1,autoHide:!1,opacity:.95,widgetPosition:{x:20,y:20}},"vibetutor-notes":[]})}catch(e){console.error("VibeTutor: failed to seed default settings",e)}}async function C(e){switch(e.action){case"save-notes":return R(e.payload)?P(e.payload):{success:!1,error:"Invalid notes payload"};case"guide-mode":return K(e.payload)?$(e.payload):{success:!1,error:"Invalid guide mode payload"};case"guide-mode-status":return Y(e.payload)?M(e.payload):{success:!1,error:"Invalid guide status payload"};case"init-session-topics":return Q(e.payload)?E(e.payload):{success:!1,error:"Invalid session init payload"};case"check-code":{if(!F(e.payload))return{success:!1,error:"Invalid check code payload"};console.log("sending to handleCheckCode");const t=await U(e.payload);return t||"failure failure"}case"solution":return X(e.payload)?B(e.payload):{success:!1,error:"Invalid solution payload"};case"go-to-workspace":return J(e.payload);case"ask-anything":{if(!Z(e.payload))return{success:!1,error:"Invalid chat payload"};const t=await x({sessionId:e.payload.sessionId,action:e.payload.action,rollingHistory:e.payload.rollingHistory,summary:e.payload.summary,query:e.payload.query,language:e.payload.language});return t||"Failure"}case"summarize-history":{if(!ee(e.payload))return{success:!1,error:"Invalid summarize payload"};const t=await G({sessionID:e.payload.sessionId,summarize:e.payload.summarize,summary:e.payload.summary});return t||"Failure"}case"supabase-login":return te(e.payload)?await se(e.payload)??{success:!1,error:"Login failed"}:{success:!1,error:"Invalid login payload"};case"supabase-signup":return re(e.payload)?await ne(e.payload)??{success:!1,error:"Signup failed"}:{success:!1,error:"Invalid signup payload"};case"clear-auth":return await k(),{success:!0};case"panel-opened":case"panel-closed":return console.debug(`VibeTutor: ${e.action}`,e.payload),{success:!0};default:return console.warn("VibeTutor: unknown action",e),{success:!1,error:"Unknown action"}}}async function P(e){try{return await u.storage.local.set({"vibetutor-notes":e.notes}),{success:!0}}catch(t){return console.error("VibeTutor: failed to save notes",t),{success:!1,error:"Storage error"}}}async function $(e){return console.debug("VibeTutor: guide-mode payload received with action: ",e.action),console.log("this is the payload at background.ts payload: ",e),V(e.sessionId,e.action,e.problem,e.topics,e.code,e.focusLine,e.language,e.rollingStateGuideMode)}async function M(e){const t=await y();return t?.jwt?z(e,t.jwt):{success:!1,error:"Unauthorized"}}async function E(e){const t=await y();return t?.jwt?N(e,t.jwt):{success:!1,error:"Unauthorized"}}async function N(e,t){const r=await f(`${l}/api/session/init`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});return r.success?r.data?.success===!1?{success:!1,status:r.status,error:c(r.data,"Session init failed")}:{success:!0}:r}async function z(e,t){const r=e.enabled?"/api/guide/enable":"/api/guide/disable",s=await f(`${l}${r}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});return s.success?s.data?.success===!1?{success:!1,status:s.status,error:c(s.data,"Guide mode status failed")}:{success:!0}:s}async function V(e,t,r,s,a,n,o,p){const g=await y(),h={"Content-Type":"application/json"};g?.jwt&&(h.Authorization=`Bearer ${g.jwt}`);const i=await f(`${l}/api/llm/guide`,{method:"POST",headers:h,body:JSON.stringify({sessionId:e,action:t,problem:r,topics:s,code:a,focusLine:n,language:o,rollingStateGuideMode:p})});return i.success?i.data?.success===!1?{success:!1,status:i.status,error:c(i.data,"Guide mode failed")}:{success:!0,...i.data}:i}async function U(e){return console.debug("VibeTutor: check-code payload received"),await q(e.sessionId,e.topics,e.code,e.action??"check-code",e.language,e.problem_no,e.problem_name,e.problem_url)}async function x(e){return console.debug("VibeTutor: ask-anything payload received"),await W(e.sessionId,e.action??"ask-anything",e.rollingHistory,e.summary,e.query,e.language)}async function G(e){return await H(e.sessionID,e.summarize,e.summary)}const b="vibetutor-auth",l="http://127.0.0.1:8000",L="vibetutor-workspace-state",_=960*60*1e3,D=15e3;function c(e,t){if(!e||typeof e!="object")return t;const r=e;return typeof r.error=="string"&&r.error.trim()?r.error:typeof r.detail=="string"&&r.detail.trim()?r.detail:typeof r.message=="string"&&r.message.trim()?r.message:t}async function f(e,t,r=D){const s=new AbortController,a=setTimeout(()=>s.abort(),r);try{const n=await fetch(e,{...t,signal:s.signal}),o=await n.text();let p=null;try{p=o?JSON.parse(o):null}catch{p=null}return n.ok?{success:!0,data:p??{},status:n.status}:{success:!1,status:n.status,unauthorized:n.status===401||n.status===403,error:c(p??o,"Request failed")}}catch(n){return n instanceof DOMException&&n.name==="AbortError"?{success:!1,error:"Request timed out",timeout:!0}:{success:!1,error:"Network request failed"}}finally{clearTimeout(a)}}let d=null;function A(e){return e?.expiresAt?Date.now()>e.expiresAt:!1}async function T(e){d=e,await u.storage.local.set({[b]:e})}async function k(){d=null,await u.storage.local.remove(b)}async function y(){return d?A(d)?(await k(),null):d:(d=(await u.storage.local.get(b))[b]??null,A(d)?(await k(),null):d)}async function B(e){return console.debug("VibeTutor: solution requested",e.sessionId),{success:!0,solution:null,message:"Solution endpoint not wired yet."}}async function J(e){try{const t=e?.url?.trim();if(!t)return{success:!1,error:"Workspace URL missing"};const r=await y();if(!r?.accessToken)return{success:!1,error:"Not authenticated"};const s=crypto.randomUUID();await u.storage.local.set({[L]:{value:s,createdAt:Date.now()}});const a=await f(`${l}/api/auth/bridge/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r.accessToken,refresh_token:r.refreshToken,state:s})});if(!a.success)return a;if(a.data?.success===!1||!a.data?.code)return{success:!1,status:a.status,error:c(a.data,"Workspace auth bridge failed")};a.data?.access_token&&await T({...r,accessToken:a.data.access_token,refreshToken:a.data.refresh_token??r.refreshToken});const n=t.includes("?")?"&":"?",o=`${t}${n}code=${encodeURIComponent(a.data.code)}&state=${encodeURIComponent(s)}`;return await u.tabs.create({url:o}),{success:!0}}catch(t){return console.error("VibeTutor: failed to open workspace",t),{success:!1,error:"Unable to open workspace tab"}}}async function q(e,t,r,s,a,n,o,p){const g=await y(),h={"Content-Type":"application/json"};g?.jwt&&(h.Authorization=`Bearer ${g.jwt}`);const i=await f(`${l}/api/llm`,{method:"POST",headers:h,body:JSON.stringify({sessionId:e,topics:t,code:r,action:s,language:a,problem_no:n,problem_name:o,problem_url:p})});if(!i.success)return i;if(i.data?.success===!1)return{success:!1,status:i.status,error:c(i.data,"Check mode failed")};const m=i.data?.reply;return m&&typeof m=="object"?{success:!0,...m}:{success:!0,resp:typeof m=="string"?m:""}}async function W(e,t,r,s,a,n){const o=await f(`${l}/api/llm/ask`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,action:t,rollingHistory:r,summary:s,query:a,language:n})});return o.success?o.data?.success===!1?{success:!1,status:o.status,error:c(o.data,"Ask failed")}:{success:!0,reply:typeof o.data?.reply=="string"?o.data.reply:""}:o}async function H(e,t,r){const s=await f(`${l}/api/llm/summarize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionID:e,summarize:t,summary:r})});return s.success?s.data?.success===!1?{success:!1,status:s.status,error:c(s.data,"Summarize failed")}:{success:!0,reply:typeof s.data?.reply=="string"?s.data.reply:""}:s}function R(e){return typeof e=="object"&&e!==null&&Array.isArray(e.notes)}function S(e){if(typeof e!="object"||e===null)return!1;const t=e;return Array.isArray(t.thoughts_to_remember)&&t.thoughts_to_remember.every(r=>typeof r=="string")&&Array.isArray(t.pitfalls)&&t.pitfalls.every(r=>typeof r=="string")}function K(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.action!="string"||typeof t.problem!="string"||typeof t.code!="string"||typeof t.focusLine!="string"||typeof t.language!="string"||typeof t.topics!="object"||t.topics===null?!1:Object.values(t.topics).every(S)}function F(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.topics!="object"||t.topics===null||typeof t.code!="string"||typeof t.action!="string"||typeof t.language!="string"||!("problem_no"in t)||t.problem_no!==null&&typeof t.problem_no!="number"||typeof t.problem_name!="string"||typeof t.problem_url!="string"?!1:Object.values(t.topics).every(S)}function Y(e){if(typeof e!="object"||e===null)return!1;const t=e;return!(typeof t.enabled!="boolean"||typeof t.sessionId!="string"||!("problem_no"in t)||t.problem_no!==null&&typeof t.problem_no!="number"||typeof t.problem_name!="string"||typeof t.problem_url!="string")}function Q(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.topics!="object"||t.topics===null?!1:Object.values(t.topics).every(S)}function X(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"}function Z(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.query!="string"||typeof t.action!="string"||!Array.isArray(t.rollingHistory)||!t.rollingHistory.every(r=>typeof r=="string")||typeof t.summary!="string"?!1:typeof t.language=="string"}function ee(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||!Array.isArray(t.summarize)||!t.summarize.every(r=>typeof r=="string")?!1:typeof t.summary=="string"}function te(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.email=="string"&&typeof t.password=="string"}function re(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.fname=="string"&&typeof t.lname=="string"&&typeof t.email=="string"&&typeof t.password=="string"}async function se(e){const t=await f(`${l}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,password:e.password})});if(!t.success)return t;if(t.data?.success===!1||!t.data?.token||!t.data?.userId)return{success:!1,status:t.status,error:c(t.data,"Invalid creds")};const r=Date.now(),s={userId:t.data.userId,jwt:t.data.token,accessToken:t.data.accessToken??t.data.access_token,refreshToken:t.data.refreshToken??t.data.refresh_token,issuedAt:r,expiresAt:r+_};return await T(s),{success:!0,...s}}async function ne(e){const t=await f(`${l}/api/auth/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fname:e.fname,lname:e.lname,email:e.email,password:e.password})});if(!t.success)return t;if(t.data?.success===!1)return{success:!1,status:t.status,error:c(t.data,"Signup failed")};if(t.data?.requiresVerification)return{success:!0,requiresVerification:!0};if(!t.data?.token||!t.data?.userId)return{success:!1,status:t.status,error:c(t.data,"Signup failed")};const r=Date.now(),s={userId:t.data.userId,jwt:t.data.token,accessToken:t.data.accessToken??t.data.access_token,refreshToken:t.data.refreshToken??t.data.refresh_token,issuedAt:r,expiresAt:r+_};return await T(s),{success:!0,...s}}u.tabs.onUpdated.addListener((e,t,r)=>{if(t.status==="complete"&&r.url){if(r.url.startsWith("chrome://")||r.url.startsWith("chrome-extension://"))return;console.log("Tab updated:",r.url)}});function ie(){}function w(e,...t){}const oe={debug:(...e)=>w(console.debug,...e),log:(...e)=>w(console.log,...e),warn:(...e)=>w(console.warn,...e),error:(...e)=>w(console.error,...e)};let I;try{I=v.main(),I instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw oe.error("The background crashed on startup!"),e}return I})();
