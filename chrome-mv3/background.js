var background=(function(){"use strict";function u(e){return e==null||typeof e=="function"?{main:e}:e}const o=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,a=u(()=>{console.log("VibeTutor: background script loaded"),o.runtime.onInstalled.addListener(async e=>{if(e.reason==="install"){console.log("VibeTutor: extension installed"),await i();try{await o.tabs.create({url:"https://example.com/welcome"})}catch(t){console.warn("VibeTutor: unable to open welcome tab",t)}}}),o.runtime.onMessage.addListener((e,t)=>c(e,t)),o.tabs.onUpdated.addListener((e,t,r)=>{t.status!=="complete"||!r.url||r.url.startsWith("chrome://")||r.url.startsWith("chrome-extension://")||console.debug("VibeTutor: tab updated",r.url)})});async function i(){try{await o.storage.local.set({"vibetutor-settings":{stealthMode:!1,autoHide:!1,opacity:.95,widgetPosition:{x:20,y:20}},"vibetutor-notes":[]})}catch(e){console.error("VibeTutor: failed to seed default settings",e)}}async function c(e,t){switch(e.action){case"save-notes":return g(e.payload)?l(e.payload):{success:!1,error:"Invalid notes payload"};case"guide-mode":return w(e.payload)?d(e.payload):{success:!1,error:"Invalid guide mode payload"};case"solution":return m(e.payload)?f(e.payload):{success:!1,error:"Invalid solution payload"};case"set-timer":return T(e.payload)?b(e.payload):{success:!1,error:"Invalid timer payload"};case"go-to-workspace":return p();case"ask-away":return I(e.payload)?y(e.payload):{success:!1,error:"Invalid chat payload"};case"get-tab-info":return h(t);case"panel-opened":case"panel-closed":return console.debug(`VibeTutor: ${e.action}`,e.payload),{success:!0};default:return console.warn("VibeTutor: unknown action",e),{success:!1,error:"Unknown action"}}}async function l(e){try{return await o.storage.local.set({"vibetutor-notes":e.notes}),{success:!0}}catch(t){return console.error("VibeTutor: failed to save notes",t),{success:!1,error:"Storage error"}}}async function d(e){return console.debug("VibeTutor: guide-mode payload received",e.sessionId),{success:!0,comments:[{id:crypto.randomUUID(),message:"Guide mode not yet implemented."}]}}async function f(e){return console.debug("VibeTutor: solution requested",e.sessionId),{success:!0,solution:null,message:"Solution endpoint not wired yet."}}async function b(e){return console.debug("VibeTutor: timer payload received",e),{success:!0}}async function p(){try{return await o.tabs.create({url:"https://example.com/workspace"}),{success:!0}}catch(e){return console.error("VibeTutor: failed to open workspace",e),{success:!1,error:"Unable to open workspace tab"}}}async function y(e){return console.debug("VibeTutor: ask-away prompt received",e.sessionId),{success:!0,reply:"Chat endpoint not wired yet."}}function h(e){if(!e.tab)return{success:!1,error:"No tab context"};const{id:t,url:r,title:k}=e.tab;return{success:!0,tab:{id:t,url:r,title:k}}}function g(e){return typeof e=="object"&&e!==null&&Array.isArray(e.notes)}function w(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&typeof e.code=="string"}function m(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"}function T(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&"timer"in e}function I(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&typeof e.text=="string"}o.tabs.onUpdated.addListener((e,t,r)=>{if(t.status==="complete"&&r.url){if(r.url.startsWith("chrome://")||r.url.startsWith("chrome-extension://"))return;console.log("Tab updated:",r.url)}});function x(){}function n(e,...t){}const v={debug:(...e)=>n(console.debug,...e),log:(...e)=>n(console.log,...e),warn:(...e)=>n(console.warn,...e),error:(...e)=>n(console.error,...e)};let s;try{s=a.main(),s instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw v.error("The background crashed on startup!"),e}return s})();
