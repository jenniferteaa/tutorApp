var background=(function(){"use strict";function y(e){return e==null||typeof e=="function"?{main:e}:e}const n=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,p=y(()=>{console.log("VibeTutor: background script loaded"),n.runtime.onInstalled.addListener(async e=>{if(e.reason==="install"){console.log("VibeTutor: extension installed"),await h();try{await n.tabs.create({url:"https://example.com/welcome"})}catch(t){console.warn("VibeTutor: unable to open welcome tab",t)}}}),n.runtime.onMessage.addListener((e,t,r)=>(g(e).then(r).catch(o=>r({success:!1,error:String(o)})),!0)),n.tabs.onUpdated.addListener((e,t,r)=>{t.status!=="complete"||!r.url||r.url.startsWith("chrome://")||r.url.startsWith("chrome-extension://")||console.debug("VibeTutor: tab updated",r.url)})});async function h(){try{await n.storage.local.set({"vibetutor-settings":{stealthMode:!1,autoHide:!1,opacity:.95,widgetPosition:{x:20,y:20}},"vibetutor-notes":[]})}catch(e){console.error("VibeTutor: failed to seed default settings",e)}}async function g(e){switch(e.action){case"save-notes":return A(e.payload)?b(e.payload):{success:!1,error:"Invalid notes payload"};case"guide-mode":return V(e.payload)?w(e.payload):{success:!1,error:"Invalid guide mode payload"};case"check-code":{if(!j(e.payload))return{success:!1,error:"Invalid check code payload"};console.log("sending to handleCheckCode");const t=await T(e.payload);return console.log("this is the data: ",t),t||"failure failure"}case"solution":return C(e.payload)?m(e.payload):{success:!1,error:"Invalid solution payload"};case"set-timer":return P(e.payload)?I(e.payload):{success:!1,error:"Invalid timer payload"};case"go-to-workspace":return S();case"ask-anything":{if(!x(e.payload))return{success:!1,error:"Invalid chat payload"};const t=await v({sessionId:e.payload.sessionId,query:e.payload.query,action:e.payload.action});return t||"Failure"}case"panel-opened":case"panel-closed":return console.debug(`VibeTutor: ${e.action}`,e.payload),{success:!0};default:return console.warn("VibeTutor: unknown action",e),{success:!1,error:"Unknown action"}}}async function b(e){try{return await n.storage.local.set({"vibetutor-notes":e.notes}),{success:!0}}catch(t){return console.error("VibeTutor: failed to save notes",t),{success:!1,error:"Storage error"}}}async function w(e){return console.debug("VibeTutor: guide-mode payload received with action: ",e.action),console.log("this is the payload at background.ts payload: ",e),k(e.sessionId,e.action,e.problem,e.topics,e.code,e.focusLine,e.rollingStateGuideMode)}async function k(e,t,r,o,i,s,q){try{const c=await fetch("http://127.0.0.1:8000/api/llm/guide",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,action:t,problem:r,topics:o,code:i,focusLine:s,rollingStateGuideMode:q})}),d=await c.text();let a=null;try{a=d?JSON.parse(d):null}catch{a=null}return c.ok?a??{success:!0}:{success:!1,error:`Backend error (${c.status}): ${a?.detail?JSON.stringify(a.detail):d}`}}catch(c){return console.error("VibeTutor: backend request failed",c),{success:!1,error:"Backend request failed"}}}async function T(e){return console.debug("VibeTutor: check-code payload received"),(await f(e.sessionId,e.code,e.action??"check-code")).reply}async function v(e){console.debug("VibeTutor: ask-anything payload received");const t=await f(e.sessionId,e.query,e.action??"ask-anything");return console.log("this is the data received: ",t.reply),t.reply}async function m(e){return console.debug("VibeTutor: solution requested",e.sessionId),{success:!0,solution:null,message:"Solution endpoint not wired yet."}}async function I(e){return console.debug("VibeTutor: timer payload received",e),{success:!0}}async function S(){try{return await n.tabs.create({url:"https://example.com/workspace"}),{success:!0}}catch(e){return console.error("VibeTutor: failed to open workspace",e),{success:!1,error:"Unable to open workspace tab"}}}async function f(e,t,r){console.log("sending code to backend:",{action:r}),console.log("this is the code: ",t);try{const o=await fetch("http://127.0.0.1:8000/api/llm",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,code:t,action:r})}),i=await o.text();let s=null;try{s=i?JSON.parse(i):null}catch{s=null}return o.ok?s??{success:!0}:{success:!1,error:`Backend error (${o.status}): ${s?.detail?JSON.stringify(s.detail):i}`}}catch(o){return console.error("VibeTutor: backend request failed",o),{success:!1,error:"Backend request failed"}}}function A(e){return typeof e=="object"&&e!==null&&Array.isArray(e.notes)}function V(e){const t=e.rollingStateGuideMode;return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&typeof e.action=="string"&&typeof e.problem=="string"&&typeof e.topics=="object"&&e.topics!==null&&Object.values(e.topics??{}).every(r=>Array.isArray(r)&&r.every(o=>typeof o=="string"))&&typeof e.code=="string"&&typeof e.focusLine=="string"&&typeof t=="object"&&t!==null&&typeof t.problem=="string"&&typeof t.topics=="object"&&t.topics!==null&&Object.values(t.topics).every(r=>Array.isArray(r)&&r.every(o=>typeof o=="string"))&&typeof t.approach=="string"&&Array.isArray(t.decisions)&&t.decisions.every(r=>typeof r=="string")&&Array.isArray(t.pitfallsFlagged)&&t.pitfallsFlagged.every(r=>typeof r=="string")&&typeof t.lastEdit=="string"&&Array.isArray(t.nudges)&&t.nudges.every(r=>typeof r=="string")&&Array.isArray(t.thoughts_to_remember)&&t.thoughts_to_remember.every(r=>typeof r=="string")}function j(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&typeof e.code=="string"&&typeof e.action=="string"}function C(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"}function P(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&"timer"in e}function x(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&typeof e.query=="string"&&typeof e.action=="string"}n.tabs.onUpdated.addListener((e,t,r)=>{if(t.status==="complete"&&r.url){if(r.url.startsWith("chrome://")||r.url.startsWith("chrome-extension://"))return;console.log("Tab updated:",r.url)}});function M(){}function u(e,...t){}const O={debug:(...e)=>u(console.debug,...e),log:(...e)=>u(console.log,...e),warn:(...e)=>u(console.warn,...e),error:(...e)=>u(console.error,...e)};let l;try{l=p.main(),l instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw O.error("The background crashed on startup!"),e}return l})();
