var background=(function(){"use strict";function O(e){return e==null||typeof e=="function"?{main:e}:e}const u=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,A=O(()=>{console.log("VibeTutor: background script loaded"),u.runtime.onInstalled.addListener(async e=>{if(e.reason==="install"){console.log("VibeTutor: extension installed"),await v();try{await u.tabs.create({url:"https://example.com/welcome"})}catch(t){console.warn("VibeTutor: unable to open welcome tab",t)}}}),u.runtime.onMessage.addListener((e,t,r)=>{if(e?.type!=="GET_MONACO_CODE")return _(e).then(r).catch(n=>r({success:!1,error:String(n)})),!0}),chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="GET_MONACO_CODE"){if(!t.tab?.id){r({ok:!1,error:"missing tab id"});return}return chrome.scripting.executeScript({target:{tabId:t.tab.id},world:"MAIN",func:()=>{const n=window.monaco;if(!n?.editor)return{ok:!1,error:"monaco not found"};const o=(n.editor.getEditors?.()||[])[0];if(o?.getValue)return{ok:!0,code:o.getValue()};const i=n.editor.getModels?.()||[];return i.length?{ok:!0,code:i[0].getValue()}:{ok:!1,error:"no editor/model found"}}},n=>{r(n?.[0]?.result??{ok:!1,error:"no result"})}),!0}}),u.tabs.onUpdated.addListener((e,t,r)=>{t.status!=="complete"||!r.url||r.url.startsWith("chrome://")||r.url.startsWith("chrome-extension://")||console.debug("VibeTutor: tab updated",r.url)})});async function v(){try{await u.storage.local.set({"vibetutor-settings":{stealthMode:!1,autoHide:!1,opacity:.95,widgetPosition:{x:20,y:20}},"vibetutor-notes":[]})}catch(e){console.error("VibeTutor: failed to seed default settings",e)}}async function _(e){switch(e.action){case"save-notes":return G(e.payload)?j(e.payload):{success:!1,error:"Invalid notes payload"};case"guide-mode":return D(e.payload)?C(e.payload):{success:!1,error:"Invalid guide mode payload"};case"guide-mode-status":return W(e.payload)?x(e.payload):{success:!1,error:"Invalid guide status payload"};case"check-code":{if(!H(e.payload))return{success:!1,error:"Invalid check code payload"};console.log("sending to handleCheckCode");const t=await V(e.payload);return t||"failure failure"}case"solution":return K(e.payload)?M(e.payload):{success:!1,error:"Invalid solution payload"};case"set-timer":return R(e.payload)?q(e.payload):{success:!1,error:"Invalid timer payload"};case"go-to-workspace":return z(e.payload);case"ask-anything":{if(!F(e.payload))return{success:!1,error:"Invalid chat payload"};const t=await P({sessionId:e.payload.sessionId,action:e.payload.action,rollingHistory:e.payload.rollingHistory,summary:e.payload.summary,query:e.payload.query});return t||"Failure"}case"summarize-history":{if(!Y(e.payload))return{success:!1,error:"Invalid summarize payload"};const t=await J({sessionID:e.payload.sessionId,summarize:e.payload.summarize,summary:e.payload.summary});return t||"Failure"}case"supabase-login":return Q(e.payload)?await Z(e.payload)??{success:!1,error:"Login failed"}:{success:!1,error:"Invalid login payload"};case"supabase-signup":return X(e.payload)?await ee(e.payload)??{success:!1,error:"Signup failed"}:{success:!1,error:"Invalid signup payload"};case"clear-auth":return await g(),{success:!0};case"panel-opened":case"panel-closed":return console.debug(`VibeTutor: ${e.action}`,e.payload),{success:!0};default:return console.warn("VibeTutor: unknown action",e),{success:!1,error:"Unknown action"}}}async function j(e){try{return await u.storage.local.set({"vibetutor-notes":e.notes}),{success:!0}}catch(t){return console.error("VibeTutor: failed to save notes",t),{success:!1,error:"Storage error"}}}async function C(e){return console.debug("VibeTutor: guide-mode payload received with action: ",e.action),console.log("this is the payload at background.ts payload: ",e),$(e.sessionId,e.action,e.problem,e.topics,e.code,e.focusLine,e.rollingStateGuideMode)}async function x(e){const t=await b();return t?.jwt?N(e,t.jwt):{success:!1,error:"Unauthorized"}}async function N(e,t){const r=e.enabled?"/api/guide/enable":"/api/guide/disable",n=await fetch(`${h}${r}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});return n.ok?{success:!0}:{success:!1,error:await n.text()||"Guide mode status failed"}}async function $(e,t,r,n,s,o,i){try{const a=await b(),f={"Content-Type":"application/json"};a?.jwt&&(f.Authorization=`Bearer ${a.jwt}`);const d=await fetch("http://127.0.0.1:8000/api/llm/guide",{method:"POST",headers:f,body:JSON.stringify({sessionId:e,action:t,problem:r,topics:n,code:s,focusLine:o,rollingStateGuideMode:i})}),p=await d.text();let c=null;try{c=p?JSON.parse(p):null}catch{c=null}return d.ok?c??{success:!0}:{success:!1,error:`Backend error (${d.status}): ${c?.detail?JSON.stringify(c.detail):p}`}}catch(a){return console.error("VibeTutor: backend request failed",a),{success:!1,error:"Backend request failed"}}}async function V(e){return console.debug("VibeTutor: check-code payload received"),(await E(e.sessionId,e.topics,e.code,e.action??"check-code",e.problem_no,e.problem_name,e.problem_url)).reply}async function P(e){console.debug("VibeTutor: ask-anything payload received");const t=await L(e.sessionId,e.action??"ask-anything",e.rollingHistory,e.summary,e.query);return console.log("this is the data received: ",t.reply),t.reply}async function J(e){return(await U(e.sessionID,e.summarize,e.summary)).reply}const y="vibetutor-auth",h="http://127.0.0.1:8000",B="vibetutor-workspace-state",k=1800*1e3;let l=null;function T(e){return e?.expiresAt?Date.now()>e.expiresAt:!1}async function S(e){l=e,await u.storage.local.set({[y]:e})}async function g(){l=null,await u.storage.local.remove(y)}async function b(){return l?T(l)?(await g(),null):l:(l=(await u.storage.local.get(y))[y]??null,T(l)?(await g(),null):l)}async function M(e){return console.debug("VibeTutor: solution requested",e.sessionId),{success:!0,solution:null,message:"Solution endpoint not wired yet."}}async function q(e){return console.debug("VibeTutor: timer payload received",e),{success:!0}}async function z(e){try{const t=e?.url?.trim();if(!t)return{success:!1,error:"Workspace URL missing"};const r=await b();if(!r?.accessToken)return{success:!1,error:"Not authenticated"};const n=crypto.randomUUID();await u.storage.local.set({[B]:{value:n,createdAt:Date.now()}});const s=await fetch(`${h}/api/auth/bridge/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r.accessToken,state:n})}),o=await s.text(),i=o?JSON.parse(o):null;if(!s.ok||!i?.code)return{success:!1,error:"Workspace auth bridge failed"};const a=t.includes("?")?"&":"?",f=`${t}${a}code=${encodeURIComponent(i.code)}&state=${encodeURIComponent(n)}`;return await u.tabs.create({url:f}),{success:!0}}catch(t){return console.error("VibeTutor: failed to open workspace",t),{success:!1,error:"Unable to open workspace tab"}}}async function E(e,t,r,n,s,o,i){try{const a=await b(),f={"Content-Type":"application/json"};a?.jwt&&(f.Authorization=`Bearer ${a.jwt}`);const d=await fetch("http://127.0.0.1:8000/api/llm",{method:"POST",headers:f,body:JSON.stringify({sessionId:e,topics:t,code:r,action:n,problem_no:s,problem_name:o,problem_url:i})}),p=await d.text();let c=null;try{c=p?JSON.parse(p):null}catch{c=null}return d.ok?c??{success:!0}:{success:!1,error:`Backend error (${d.status}): ${c?.detail?JSON.stringify(c.detail):p}`}}catch(a){return console.error("Code check failed",a),{success:!1,error:"Backend code check request failed"}}}async function L(e,t,r,n,s){try{const o=await fetch("http://127.0.0.1:8000/api/llm/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,action:t,rollingHistory:r,summary:n,query:s})}),i=await o.text();let a=null;try{a=i?JSON.parse(i):null}catch{a=null}return o.ok?a??{success:!0}:{success:!1,error:`Backend error (${o.status}): ${a?.detail?JSON.stringify(a.detail):i}`}}catch(o){return console.error("VibeTutor: backend request failed",o),{success:!1,error:"Backend request failed"}}}async function U(e,t,r){try{const n=await fetch("http://127.0.0.1:8000/api/llm/summarize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionID:e,summarize:t,summary:r})}),s=await n.text();let o=null;try{o=s?JSON.parse(s):null}catch{o=null}return n.ok?o??{success:!0}:{success:!1,error:`Backend error (${n.status}): ${o?.detail?JSON.stringify(o.detail):s}`}}catch(n){return console.error("VibeTutor: summary request failed",n),{success:!1,error:"Summary request failed"}}}function G(e){return typeof e=="object"&&e!==null&&Array.isArray(e.notes)}function I(e){if(typeof e!="object"||e===null)return!1;const t=e;return Array.isArray(t.thoughts_to_remember)&&t.thoughts_to_remember.every(r=>typeof r=="string")&&Array.isArray(t.pitfalls)&&t.pitfalls.every(r=>typeof r=="string")}function D(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.action!="string"||typeof t.problem!="string"||typeof t.code!="string"||typeof t.focusLine!="string"||typeof t.topics!="object"||t.topics===null?!1:Object.values(t.topics).every(I)}function H(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.topics!="object"||t.topics===null||typeof t.code!="string"||typeof t.action!="string"||!("problem_no"in t)||t.problem_no!==null&&typeof t.problem_no!="number"||typeof t.problem_name!="string"||typeof t.problem_url!="string"?!1:Object.values(t.topics).every(I)}function W(e){if(typeof e!="object"||e===null)return!1;const t=e;return!(typeof t.enabled!="boolean"||typeof t.sessionId!="string"||!("problem_no"in t)||t.problem_no!==null&&typeof t.problem_no!="number"||typeof t.problem_name!="string"||typeof t.problem_url!="string")}function K(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"}function R(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&"timer"in e}function F(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.query!="string"||typeof t.action!="string"||!Array.isArray(t.rollingHistory)||!t.rollingHistory.every(r=>typeof r=="string")?!1:typeof t.summary=="string"}function Y(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||!Array.isArray(t.summarize)||!t.summarize.every(r=>typeof r=="string")?!1:typeof t.summary=="string"}function Q(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.email=="string"&&typeof t.password=="string"}function X(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.fname=="string"&&typeof t.lname=="string"&&typeof t.email=="string"&&typeof t.password=="string"}async function Z(e){try{const t=await fetch(`${h}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,password:e.password})}),r=await t.text(),n=r?JSON.parse(r):null;if(!t.ok||!n?.token||!n?.userId)return null;const s=Date.now(),o={userId:n.userId,jwt:n.token,accessToken:n.accessToken??n.access_token,issuedAt:s,expiresAt:s+k};return await S(o),o}catch(t){return console.error("VibeTutor: supabase login failed",t),null}}async function ee(e){try{const t=await fetch(`${h}/api/auth/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fname:e.fname,lname:e.lname,email:e.email,password:e.password})}),r=await t.text(),n=r?JSON.parse(r):null;if(!t.ok||!n)return null;if(n?.requiresVerification)return{requiresVerification:!0};if(!n?.token||!n?.userId)return null;const s=Date.now(),o={userId:n.userId,jwt:n.token,accessToken:n.accessToken??n.access_token,issuedAt:s,expiresAt:s+k};return await S(o),o}catch(t){return console.error("VibeTutor: supabase signup failed",t),null}}u.tabs.onUpdated.addListener((e,t,r)=>{if(t.status==="complete"&&r.url){if(r.url.startsWith("chrome://")||r.url.startsWith("chrome-extension://"))return;console.log("Tab updated:",r.url)}});function ne(){}function m(e,...t){}const te={debug:(...e)=>m(console.debug,...e),log:(...e)=>m(console.log,...e),warn:(...e)=>m(console.warn,...e),error:(...e)=>m(console.error,...e)};let w;try{w=A.main(),w instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw te.error("The background crashed on startup!"),e}return w})();
