var background=(function(){"use strict";function I(e){return e==null||typeof e=="function"?{main:e}:e}const o=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;async function z(e){return new Promise(t=>{chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:()=>{const r=window.monaco;if(!r?.editor)return{ok:!1,error:"monaco not found"};const a=(r.editor.getEditors?.()||[])[0];if(a?.getValue)return{ok:!0,code:a.getValue()};const n=r.editor.getModels?.()||[];return n.length?{ok:!0,code:n[0].getValue()}:{ok:!1,error:"no editor/model found"}}},r=>{t(r?.[0]?.result??{ok:!1,error:"no result"})})})}const b="vibetutor-auth",f="http://127.0.0.1:8000",C="vibetutor-workspace-state",j=960*60*1e3,O=15e3;let p=null;function _(e){return e?.expiresAt?Date.now()>e.expiresAt:!1}async function T(e){p=e,await o.storage.local.set({[b]:e})}async function k(){p=null,await o.storage.local.remove(b)}async function h(){return p?_(p)?(await k(),null):p:(p=(await o.storage.local.get(b))[b]??null,_(p)?(await k(),null):p)}function c(e,t){if(!e||typeof e!="object")return t;const r=e;return typeof r.error=="string"&&r.error.trim()?r.error:typeof r.detail=="string"&&r.detail.trim()?r.detail:typeof r.message=="string"&&r.message.trim()?r.message:t}async function d(e,t,r=O){const s=new AbortController,a=setTimeout(()=>s.abort(),r);try{const n=await fetch(e,{...t,signal:s.signal}),l=await n.text();let i=null;try{i=l?JSON.parse(l):null}catch{i=null}return n.ok?{success:!0,data:i??{},status:n.status}:{success:!1,status:n.status,unauthorized:n.status===401||n.status===403,error:c(i??l,"Request failed")}}catch(n){return n instanceof DOMException&&n.name==="AbortError"?{success:!1,error:"Request timed out",timeout:!0}:{success:!1,error:"Network request failed"}}finally{clearTimeout(a)}}async function M(e){console.debug("VibeTutor: ask-anything payload received");const t=await h();return t?.jwt?await $(t.jwt,e.sessionId,e.action??"ask-anything",e.rollingHistory,e.summary,e.query,e.language):{success:!1,unauthorized:!0}}async function $(e,t,r,s,a,n,l){const i=await d(`${f}/api/llm/ask`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({sessionId:t,action:r,rollingHistory:s,summary:a,query:n,language:l})});if(!i.success)return i;if(i.data?.success===!1){const g=c(i.data,"Ask failed");return{success:!1,status:i.status,error:g,unauthorized:/unauthorized/i.test(g)}}return{success:!0,data:{reply:typeof i.data?.reply=="string"?i.data.reply:""}}}async function P(e){console.debug("VibeTutor: check-code payload received");const t=await h();return t?.jwt?await E(t.jwt,e.sessionId,e.topics,e.code,e.action??"check-code",e.language,e.problem_no,e.problem_name,e.problem_url):{success:!1,unauthorized:!0}}async function E(e,t,r,s,a,n,l,i,g){const m={"Content-Type":"application/json"};m.Authorization=`Bearer ${e}`;const u=await d(`${f}/api/llm`,{method:"POST",headers:m,body:JSON.stringify({sessionId:t,topics:r,code:s,action:a,language:n,problem_no:l,problem_name:i,problem_url:g})});if(!u.success)return u;if(u.data?.success===!1){const v=c(u.data,"Check mode failed");return{success:!1,status:u.status,error:v,unauthorized:/unauthorized/i.test(v)}}const y=u.data?.reply;return y&&typeof y=="object"?{success:!0,data:y}:{success:!0,data:{resp:typeof y=="string"?y:""}}}async function V(){return await k(),{success:!0}}async function N(e){const t=await d(`${f}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,password:e.password})});if(!t.success)return t;if(t.success&&console.log("this is the response for login: ",t),t.data?.success===!1||!t.data?.token||!t.data?.userId)return{success:!1,status:t.status,error:c(t.data,"Invalid creds")};const r=Date.now(),s={userId:t.data.userId,jwt:t.data.token,accessToken:t.data.accessToken??t.data.access_token,refreshToken:t.data.refreshToken??t.data.refresh_token,issuedAt:r,expiresAt:r+j};return await T(s),{success:!0,data:{...s,token:s.jwt}}}async function U(e){const t=await d(`${f}/api/auth/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fname:e.fname,lname:e.lname,email:e.email,password:e.password})});if(!t.success)return t;if(t.data?.success===!1)return{success:!1,status:t.status,error:c(t.data,"Signup failed")};if(t.data?.requiresVerification)return{success:!0,data:{requiresVerification:!0,userId:t.data.userId}};if(!t.data?.token||!t.data?.userId)return{success:!1,status:t.status,error:c(t.data,"Signup failed")};const r=Date.now(),s={userId:t.data.userId,jwt:t.data.token,accessToken:t.data.accessToken??t.data.access_token,refreshToken:t.data.refreshToken??t.data.refresh_token,issuedAt:r,expiresAt:r+j};return await T(s),{success:!0,data:{...s,token:s.jwt}}}async function x(e){console.debug("VibeTutor: guide-mode payload received with action: ",e.action),console.log("this is the payload at background.ts payload: ",e);const t=await h();return t?.jwt?G(t.jwt,e.sessionId,e.action,e.problem,e.topics,e.code,e.focusLine,e.language,e.rollingStateGuideMode):{success:!1,unauthorized:!0}}async function L(e){const t=await h();return t?.jwt?B(e,t.jwt):{success:!1,unauthorized:!0}}async function B(e,t){const r=e.enabled?"/api/guide/enable":"/api/guide/disable",s=await d(`${f}${r}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});if(!s.success)return s;if(s.data?.success===!1){const a=c(s.data,"Guide mode status failed");return{success:!1,status:s.status,error:a,unauthorized:/unauthorized/i.test(a)}}return{success:!0}}async function G(e,t,r,s,a,n,l,i,g){const m={"Content-Type":"application/json"};m.Authorization=`Bearer ${e}`;const u=await d(`${f}/api/llm/guide`,{method:"POST",headers:m,body:JSON.stringify({sessionId:t,action:r,problem:s,topics:a,code:n,focusLine:l,language:i,rollingStateGuideMode:g})});if(!u.success)return u;if(u.data?.success===!1){const y=c(u.data,"Guide mode failed");return{success:!1,status:u.status,error:y,unauthorized:/unauthorized/i.test(y)}}return{success:!0,data:{reply:u.data?.reply}}}async function D(e){try{return await o.storage.local.set({"vibetutor-notes":e.notes}),{success:!0}}catch(t){return console.error("VibeTutor: failed to save notes",t),{success:!1,error:"Storage error"}}}async function J(e){const t=await h();return t?.jwt?q(e,t.jwt):{success:!1,unauthorized:!0}}async function q(e,t){const r=await d(`${f}/api/session/init`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});if(!r.success)return r;if(r.data?.success===!1){const s=c(r.data,"Session init failed");return{success:!1,status:r.status,error:s,unauthorized:/unauthorized/i.test(s)}}return{success:!0}}async function W(e){const t=await h();return t?.jwt?await H(t.jwt,e.sessionID,e.summarize,e.summary):{success:!1,unauthorized:!0}}async function H(e,t,r,s){const a=await d(`${f}/api/llm/summarize`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({sessionID:t,summarize:r,summary:s})});if(!a.success)return a;if(a.data?.success===!1){const n=c(a.data,"Summarize failed");return{success:!1,status:a.status,error:n,unauthorized:/unauthorized/i.test(n)}}return{success:!0,data:{reply:typeof a.data?.reply=="string"?a.data.reply:""}}}async function R(e){const t={value:e,createdAt:Date.now()};await o.storage.local.set({[C]:t})}async function K(e){try{const t=e?.url?.trim();if(!t)return{success:!1,error:"Workspace URL missing"};const r=await h();if(!r?.accessToken)return{success:!1,unauthorized:!0};const s=crypto.randomUUID();await R(s);const a=await d(`${f}/api/auth/bridge/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r.accessToken,refresh_token:r.refreshToken,state:s})});if(!a.success)return a;if(a.data?.success===!1||!a.data?.code)return{success:!1,status:a.status,error:c(a.data,"Workspace auth bridge failed")};a.data?.access_token&&await T({...r,accessToken:a.data.access_token,refreshToken:a.data.refresh_token??r.refreshToken});const n=t.includes("?")?"&":"?",l=`${t}${n}code=${encodeURIComponent(a.data.code)}&state=${encodeURIComponent(s)}`;return await o.tabs.create({url:l}),{success:!0}}catch(t){return console.error("VibeTutor: failed to open workspace",t),{success:!1,error:"Unable to open workspace tab"}}}function F(e){return typeof e=="object"&&e!==null&&Array.isArray(e.notes)}function S(e){if(typeof e!="object"||e===null)return!1;const t=e;return Array.isArray(t.thoughts_to_remember)&&t.thoughts_to_remember.every(r=>typeof r=="string")&&Array.isArray(t.pitfalls)&&t.pitfalls.every(r=>typeof r=="string")}function Y(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.action!="string"||typeof t.problem!="string"||typeof t.code!="string"||typeof t.focusLine!="string"||typeof t.language!="string"||typeof t.topics!="object"||t.topics===null?!1:Object.values(t.topics).every(S)}function Q(e){if(typeof e!="object"||e===null)return!1;const t=e;return!(typeof t.enabled!="boolean"||typeof t.sessionId!="string"||!("problem_no"in t)||t.problem_no!==null&&typeof t.problem_no!="number"||typeof t.problem_name!="string"||typeof t.problem_url!="string")}function X(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.topics!="object"||t.topics===null||typeof t.code!="string"||typeof t.action!="string"||typeof t.language!="string"||!("problem_no"in t)||t.problem_no!==null&&typeof t.problem_no!="number"||typeof t.problem_name!="string"||typeof t.problem_url!="string"?!1:Object.values(t.topics).every(S)}function Z(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.topics!="object"||t.topics===null?!1:Object.values(t.topics).every(S)}function ee(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||typeof t.query!="string"||typeof t.action!="string"||!Array.isArray(t.rollingHistory)||!t.rollingHistory.every(r=>typeof r=="string")||typeof t.summary!="string"?!1:typeof t.language=="string"}function te(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.sessionId!="string"||!Array.isArray(t.summarize)||!t.summarize.every(r=>typeof r=="string")?!1:typeof t.summary=="string"}function re(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.email=="string"&&typeof t.password=="string"}function se(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.fname=="string"&&typeof t.lname=="string"&&typeof t.email=="string"&&typeof t.password=="string"}async function ae(e,t){switch(e.action){case"save-notes":return F(e.payload)?D(e.payload):{success:!1,error:"Invalid notes payload"};case"guide-mode":return Y(e.payload)?x(e.payload):{success:!1,error:"Invalid guide mode payload"};case"guide-mode-status":return Q(e.payload)?L(e.payload):{success:!1,error:"Invalid guide status payload"};case"init-session-topics":return Z(e.payload)?J(e.payload):{success:!1,error:"Invalid session init payload"};case"check-code":return X(e.payload)?(console.log("sending to handleCheckCode"),await P(e.payload)??{success:!1,error:"Check failed"}):{success:!1,error:"Invalid check code payload"};case"go-to-workspace":return K(e.payload);case"ask-anything":return ee(e.payload)?await M({sessionId:e.payload.sessionId,action:e.payload.action,rollingHistory:e.payload.rollingHistory,summary:e.payload.summary,query:e.payload.query,language:e.payload.language})??{success:!1,error:"Ask failed"}:{success:!1,error:"Invalid chat payload"};case"summarize-history":return te(e.payload)?await W({sessionID:e.payload.sessionId,summarize:e.payload.summarize,summary:e.payload.summary})??{success:!1,error:"Summarize failed"}:{success:!1,error:"Invalid summarize payload"};case"supabase-login":return re(e.payload)?await N(e.payload)??{success:!1,error:"Login failed"}:{success:!1,error:"Invalid login payload"};case"supabase-signup":return se(e.payload)?await U(e.payload)??{success:!1,error:"Signup failed"}:{success:!1,error:"Invalid signup payload"};case"clear-auth":return V();case"panel-opened":case"panel-closed":return console.debug(`VibeTutor: ${e.action}`,e.payload),{success:!0};default:return console.warn("VibeTutor: unknown action",e),{success:!1,error:"Unknown action"}}}async function ne(){try{await o.storage.local.set({"vibetutor-settings":{stealthMode:!1,autoHide:!1,opacity:.95,widgetPosition:{x:20,y:20}},"vibetutor-notes":[]})}catch(e){console.error("VibeTutor: failed to seed default settings",e)}}const oe=I(()=>{console.log("VibeTutor: background script loaded"),o.runtime.onInstalled.addListener(async r=>{if(r.reason==="install"){console.log("VibeTutor: extension installed"),await ne();try{await o.tabs.create({url:"https://example.com/welcome"})}catch(s){console.warn("VibeTutor: unable to open welcome tab",s)}}}),o.runtime.onMessage.addListener((r,s,a)=>{if(r?.type!=="GET_MONACO_CODE")return ae(r).then(a).catch(n=>a({success:!1,error:String(n)})),!0}),chrome.runtime.onMessage.addListener((r,s,a)=>{if(r.type==="GET_MONACO_CODE"){if(!s.tab?.id){a({ok:!1,error:"missing tab id"});return}return z(s.tab.id).then(a),!0}});const e=r=>{if(!r)return!1;try{const s=new URL(r);return s.protocol==="https:"&&s.hostname==="leetcode.com"&&s.pathname.startsWith("/problems/")}catch{return!1}},t=async(r,s)=>{try{e(s)?await o.action.enable(r):await o.action.disable(r)}catch(a){console.debug("VibeTutor: failed to update action state",a)}};o.tabs.onUpdated.addListener((r,s,a)=>{a.url&&(a.url.startsWith("chrome://")||a.url.startsWith("chrome-extension://")||((s.status==="complete"||s.url)&&t(r,a.url),console.debug("VibeTutor: tab updated",a.url)))}),o.tabs.onActivated.addListener(async({tabId:r})=>{try{const s=await o.tabs.get(r);await t(r,s.url)}catch(s){console.debug("VibeTutor: failed to update action on activate",s)}}),o.tabs.query({active:!0,currentWindow:!0}).then(r=>{const s=r[0];if(s?.id)return t(s.id,s.url)})});function ce(){}function w(e,...t){}const ie={debug:(...e)=>w(console.debug,...e),log:(...e)=>w(console.log,...e),warn:(...e)=>w(console.warn,...e),error:(...e)=>w(console.error,...e)};let A;try{A=oe.main(),A instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw ie.error("The background crashed on startup!"),e}return A})();
