var background=(function(){"use strict";function p(e){return e==null||typeof e=="function"?{main:e}:e}const c=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,h=p(()=>{console.log("VibeTutor: background script loaded"),c.runtime.onInstalled.addListener(async e=>{if(e.reason==="install"){console.log("VibeTutor: extension installed"),await b();try{await c.tabs.create({url:"https://example.com/welcome"})}catch(r){console.warn("VibeTutor: unable to open welcome tab",r)}}}),c.runtime.onMessage.addListener((e,r,t)=>{if(e?.type!=="GET_MONACO_CODE")return m(e).then(t).catch(n=>t({success:!1,error:String(n)})),!0}),chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.type==="GET_MONACO_CODE"){if(!r.tab?.id){t({ok:!1,error:"missing tab id"});return}return chrome.scripting.executeScript({target:{tabId:r.tab.id},world:"MAIN",func:()=>{const n=window.monaco;if(!n?.editor)return{ok:!1,error:"monaco not found"};const o=(n.editor.getEditors?.()||[])[0];if(o?.getValue)return{ok:!0,code:o.getValue()};const i=n.editor.getModels?.()||[];return i.length?{ok:!0,code:i[0].getValue()}:{ok:!1,error:"no editor/model found"}}},n=>{t(n?.[0]?.result??{ok:!1,error:"no result"})}),!0}}),c.tabs.onUpdated.addListener((e,r,t)=>{r.status!=="complete"||!t.url||t.url.startsWith("chrome://")||t.url.startsWith("chrome-extension://")||console.debug("VibeTutor: tab updated",t.url)})});async function b(){try{await c.storage.local.set({"vibetutor-settings":{stealthMode:!1,autoHide:!1,opacity:.95,widgetPosition:{x:20,y:20}},"vibetutor-notes":[]})}catch(e){console.error("VibeTutor: failed to seed default settings",e)}}async function m(e){switch(e.action){case"save-notes":return x(e.payload)?g(e.payload):{success:!1,error:"Invalid notes payload"};case"guide-mode":return A(e.payload)?k(e.payload):{success:!1,error:"Invalid guide mode payload"};case"check-code":{if(!P(e.payload))return{success:!1,error:"Invalid check code payload"};console.log("sending to handleCheckCode");const r=await T(e.payload);return r||"failure failure"}case"solution":return M(e.payload)?I(e.payload):{success:!1,error:"Invalid solution payload"};case"set-timer":return $(e.payload)?O(e.payload):{success:!1,error:"Invalid timer payload"};case"go-to-workspace":return C();case"ask-anything":{if(!q(e.payload))return{success:!1,error:"Invalid chat payload"};const r=await S({sessionId:e.payload.sessionId,action:e.payload.action,rollingHistory:e.payload.rollingHistory,summary:e.payload.summary,query:e.payload.query});return r||"Failure"}case"summarize-history":{if(!B(e.payload))return{success:!1,error:"Invalid summarize payload"};const r=await v({sessionID:e.payload.sessionId,summarize:e.payload.summarize,summary:e.payload.summary});return r||"Failure"}case"panel-opened":case"panel-closed":return console.debug(`VibeTutor: ${e.action}`,e.payload),{success:!0};default:return console.warn("VibeTutor: unknown action",e),{success:!1,error:"Unknown action"}}}async function g(e){try{return await c.storage.local.set({"vibetutor-notes":e.notes}),{success:!0}}catch(r){return console.error("VibeTutor: failed to save notes",r),{success:!1,error:"Storage error"}}}async function k(e){return console.debug("VibeTutor: guide-mode payload received with action: ",e.action),console.log("this is the payload at background.ts payload: ",e),w(e.sessionId,e.action,e.problem,e.topics,e.code,e.focusLine,e.rollingStateGuideMode)}async function w(e,r,t,n,s,o,i){try{const a=await fetch("http://127.0.0.1:8000/api/llm/guide",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,action:r,problem:t,topics:n,code:s,focusLine:o,rollingStateGuideMode:i})}),f=await a.text();let u=null;try{u=f?JSON.parse(f):null}catch{u=null}return a.ok?u??{success:!0}:{success:!1,error:`Backend error (${a.status}): ${u?.detail?JSON.stringify(u.detail):f}`}}catch(a){return console.error("VibeTutor: backend request failed",a),{success:!1,error:"Backend request failed"}}}async function T(e){return console.debug("VibeTutor: check-code payload received"),(await V(e.sessionId,e.topics,e.code,e.action??"check-code")).reply}async function S(e){console.debug("VibeTutor: ask-anything payload received");const r=await N(e.sessionId,e.action??"ask-anything",e.rollingHistory,e.summary,e.query);return console.log("this is the data received: ",r.reply),r.reply}async function v(e){return(await j(e.sessionID,e.summarize,e.summary)).reply}async function I(e){return console.debug("VibeTutor: solution requested",e.sessionId),{success:!0,solution:null,message:"Solution endpoint not wired yet."}}async function O(e){return console.debug("VibeTutor: timer payload received",e),{success:!0}}async function C(){try{return await c.tabs.create({url:"https://example.com/workspace"}),{success:!0}}catch(e){return console.error("VibeTutor: failed to open workspace",e),{success:!1,error:"Unable to open workspace tab"}}}async function V(e,r,t,n){try{const s=await fetch("http://127.0.0.1:8000/api/llm",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,topics:r,code:t,action:n})}),o=await s.text();let i=null;try{i=o?JSON.parse(o):null}catch{i=null}return s.ok?i??{success:!0}:{success:!1,error:`Backend error (${s.status}): ${i?.detail?JSON.stringify(i.detail):o}`}}catch(s){return console.error("Code check failed",s),{success:!1,error:"Backend code check request failed"}}}async function N(e,r,t,n,s){try{const o=await fetch("http://127.0.0.1:8000/api/llm/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,action:r,rollingHistory:t,summary:n,query:s})}),i=await o.text();let a=null;try{a=i?JSON.parse(i):null}catch{a=null}return o.ok?a??{success:!0}:{success:!1,error:`Backend error (${o.status}): ${a?.detail?JSON.stringify(a.detail):i}`}}catch(o){return console.error("VibeTutor: backend request failed",o),{success:!1,error:"Backend request failed"}}}async function j(e,r,t){try{const n=await fetch("http://127.0.0.1:8000/api/llm/summarize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionID:e,summarize:r,summary:t})}),s=await n.text();let o=null;try{o=s?JSON.parse(s):null}catch{o=null}return n.ok?o??{success:!0}:{success:!1,error:`Backend error (${n.status}): ${o?.detail?JSON.stringify(o.detail):s}`}}catch(n){return console.error("VibeTutor: summary request failed",n),{success:!1,error:"Summary request failed"}}}function x(e){return typeof e=="object"&&e!==null&&Array.isArray(e.notes)}function y(e){if(typeof e!="object"||e===null)return!1;const r=e;return Array.isArray(r.thoughts_to_remember)&&r.thoughts_to_remember.every(t=>typeof t=="string")&&Array.isArray(r.pitfalls)&&r.pitfalls.every(t=>typeof t=="string")}function A(e){if(typeof e!="object"||e===null)return!1;const r=e;return typeof r.sessionId!="string"||typeof r.action!="string"||typeof r.problem!="string"||typeof r.code!="string"||typeof r.focusLine!="string"||typeof r.topics!="object"||r.topics===null?!1:Object.values(r.topics).every(y)}function P(e){if(typeof e!="object"||e===null)return!1;const r=e;return typeof r.sessionId!="string"||typeof r.topics!="object"||r.topics===null||typeof r.code!="string"||typeof r.action!="string"?!1:Object.values(r.topics).every(y)}function M(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"}function $(e){return typeof e=="object"&&e!==null&&typeof e.sessionId=="string"&&"timer"in e}function q(e){if(typeof e!="object"||e===null)return!1;const r=e;return typeof r.sessionId!="string"||typeof r.query!="string"||typeof r.action!="string"||!Array.isArray(r.rollingHistory)||!r.rollingHistory.every(t=>typeof t=="string")?!1:typeof r.summary=="string"}function B(e){if(typeof e!="object"||e===null)return!1;const r=e;return typeof r.sessionId!="string"||!Array.isArray(r.summarize)||!r.summarize.every(t=>typeof t=="string")?!1:typeof r.summary=="string"}c.tabs.onUpdated.addListener((e,r,t)=>{if(r.status==="complete"&&t.url){if(t.url.startsWith("chrome://")||t.url.startsWith("chrome-extension://"))return;console.log("Tab updated:",t.url)}});function _(){}function l(e,...r){}const J={debug:(...e)=>l(console.debug,...e),log:(...e)=>l(console.log,...e),warn:(...e)=>l(console.warn,...e),error:(...e)=>l(console.error,...e)};let d;try{d=h.main(),d instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw J.error("The background crashed on startup!"),e}return d})();
